const express = require("express");
const userRouter = express.Router();
userRouter.use(express.json());
const { loginUser, addUser, findUser } = require("../services/users.service");
const { customErrors } = require("../helpers/errors.helper");

userRouter
  .route("/signup")
  .all(async (req, res, next) => {
    try {
      const user = await findUser(req.body.username);
      !user && next(customErrors.usernameTaken);
    } catch (err) {
      next(err);
    }
  })
  .post(async (req, res, next) => {
    try {
      const userAdded = await addUser(req.body);
      res.status(201).send(userAdded);
    } catch (err) {
      next(err);
    }
  });

userRouter.route("/login").post(async (req, res, next) => {
  try {
    const token = await loginUser(req.body);
    !token ? next(customErrors.loginFailure) : res.send(token);
  } catch (err) {
    next(err);
  }
});

module.exports = userRouter;
